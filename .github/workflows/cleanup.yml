name: 'Cleanup JFrog Platform for BookVerse Demo'
on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Type "DELETE" to confirm cleanup (this action cannot be undone)'
        required: true
        type: string

jobs:
  cleanup-platform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest

      - name: Configure JFrog CLI for Admin
        run: |
          jfrog config add bookverse-admin --url=${{ vars.JFROG_URL }} --access-token=${{ secrets.JFROG_ADMIN_TOKEN }} --interactive=false
          jfrog config use bookverse-admin

      - name: Start Build Info Collection
        run: |
          echo "üîÑ Starting build info collection for BookVerse Platform Cleanup"
          jfrog rt build-start

      - name: Validate Confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm_cleanup }}" != "DELETE" ]]; then
            echo "‚ùå Cleanup cancelled: Invalid confirmation input"
            echo "   You must type 'DELETE' to confirm cleanup"
            exit 1
          fi
          echo "‚úÖ Cleanup confirmed. Proceeding with BookVerse project cleanup..."

      - name: Cleanup BookVerse Project
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
        run: ./.github/scripts/setup/cleanup.sh

      - name: Publish Build Info
        if: always()
        run: |
          echo "üìä Publishing build info for BookVerse Platform Cleanup"
          jfrog rt build-publish
          echo "‚úÖ Build info published successfully"

      - name: Build Info Summary
        if: always()
        run: |
          echo "üìã BookVerse Platform Cleanup Complete"
          echo "   Build Name: ${JFROG_CLI_BUILD_NAME:-'BookVerse-Cleanup'}"
          echo "   Build Number: ${JFROG_CLI_BUILD_NUMBER:-${{ github.run_number }}}"
          echo "   Build URL: ${JFROG_CLI_BUILD_URL:-${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}}"
          echo "   All cleanup actions have been captured in JFrog build info"
      
      # Note: This will completely remove the BookVerse project and all resources!
      # Use with caution - this action cannot be undone.
