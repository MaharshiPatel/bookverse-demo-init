name: '🔍 Discover Cleanup'

on:
  workflow_dispatch:
    inputs:
      verbosity_level:
        description: 'Verbosity level (0=quiet, 1=normal, 2=verbose)'
        required: false
        default: '1'
        type: choice
        options:
        - '0'
        - '1'
        - '2'

permissions:
  contents: read
  actions: write

jobs:
  discover-resources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest

      - name: Configure JFrog CLI for Admin
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
        run: |
          jf c add bookverse-admin --url="${JFROG_URL}" --access-token="${JFROG_ADMIN_TOKEN}" --interactive=false --overwrite
          jf c use bookverse-admin

      - name: 🔍 Discovery Phase - Find Resources to Delete
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          VERBOSITY: ${{ inputs.verbosity_level }}
        run: |
          echo "🔍 DISCOVERY MODE: Finding resources to delete"
          echo "=============================================="
          echo ""
          echo "This workflow ONLY discovers and reports - NO DELETION occurs"
          echo ""
          
          # Create discovery-only script in the correct directory
          cd .github/scripts/setup
          cp cleanup_project_based.sh discovery_only.sh
          
          # Modify to stop after discovery (before get_user_approval)
          cat > discovery_patch.sh << 'EOF'
          echo ""
          echo "🛡️ DISCOVERY COMPLETE - NO DELETION PERFORMED"
          echo "=============================================="
          echo ""
          echo "📋 To execute the deletion:"
          echo "  1. Review the preview above carefully"
          echo "  2. Run 🗑️ Execute Cleanup workflow"
          echo "  3. Set SKIP_PROTECTION=true for automated deletion"
          echo ""
          echo "💾 Preview saved to: $preview_file"
          exit 0
          EOF
          
          # Replace the get_user_approval section with discovery completion
          sed -i '/get_user_approval/,/^fi$/r discovery_patch.sh' ./discovery_only.sh
          sed -i '/get_user_approval/,/^fi$/d' ./discovery_only.sh
          
          # Run discovery from the correct directory
          bash ./discovery_only.sh
          cd - # Return to root directory
          
          # Find the preview file and add it to job summary
          preview_file=$(find /tmp -name "deletion_preview.txt" 2>/dev/null | head -1)
          if [[ -f "$preview_file" ]]; then
            echo "📋 Preview file found: $preview_file"
          else
            echo "⚠️ Preview file not found, will extract from temp directory"
            preview_file="/tmp/bookverse_cleanup_*/deletion_preview.txt"
          fi

      - name: 📋 Discovery Report Summary
        run: |
          echo "## 🔍 Cleanup Discovery Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Discovery completed successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find and include the preview file content
          preview_file=$(find /tmp -name "deletion_preview.txt" 2>/dev/null | head -1)
          if [[ -f "$preview_file" ]]; then
            echo "### 📋 Resources Found for Deletion:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "$preview_file" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⚠️ No preview file generated" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for discovery details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. 👀 **Review the discovery report above** carefully" >> $GITHUB_STEP_SUMMARY
          echo "2. 🗑️ **Run Execute Cleanup workflow** to execute deletion" >> $GITHUB_STEP_SUMMARY
          echo "3. ⚠️ **Type 'DELETE' and optionally set skip_protection=true** for execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Important:" >> $GITHUB_STEP_SUMMARY
          echo "- **🔍 Discover Cleanup** workflow **DOES NOT DELETE** anything" >> $GITHUB_STEP_SUMMARY
          echo "- Resources are only **discovered and reported**" >> $GITHUB_STEP_SUMMARY
          echo "- Use **🗑️ Execute Cleanup** workflow for actual deletion" >> $GITHUB_STEP_SUMMARY
