name: '🗑️ Execute Cleanup'
on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Type "DELETE" to confirm cleanup (this action cannot be undone)'
        required: true
        type: string
      skip_protection:
        description: 'Skip protection layer (NOT RECOMMENDED)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

jobs:
  cleanup-platform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest

      - name: Configure JFrog CLI for Admin
        run: |
          jfrog config add bookverse-admin --url=${{ vars.JFROG_URL }} --access-token=${{ secrets.JFROG_ADMIN_TOKEN }} --interactive=false
          jfrog config use bookverse-admin

      - name: Validate Confirmation
        run: |
          echo "🔍 Validating confirmation input..."
          
          if [[ "${{ github.event.inputs.confirm_cleanup }}" != "DELETE" ]]; then
            echo "❌ Cleanup cancelled: Invalid confirmation input"
            echo "   You must type 'DELETE' to confirm cleanup"
            echo "   Current input: '${{ github.event.inputs.confirm_cleanup }}'"
            exit 1
          fi
          
          echo "✅ Cleanup confirmed. Proceeding with BookVerse project cleanup..."
          
          if [[ "${{ github.event.inputs.skip_protection }}" == "true" ]]; then
            echo "🚨 WARNING: Protection layer will be bypassed"
          else
            echo "🛡️ Protection layer active - will fail if interactive approval needed"
            echo "💡 Consider using 🔍 Discover Cleanup workflow first for safer operation"
          fi

      - name: 🛡️ Validate Cleanup Report
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          # Run cleanup report validation
          bash ./.github/scripts/setup/validate_cleanup_report.sh

      - name: 🗑️ Execute Cleanup from Report
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
          SKIP_PROTECTION: ${{ github.event.inputs.skip_protection }}
        run: |
          # Run cleanup from shared report instead of discovering again
          echo "📋 Executing cleanup from shared discovery report..."
          bash ./.github/scripts/setup/cleanup_from_report.sh
          
          # Clear and commit the cleanup report after successful execution
          git config --global user.name "BookVerse Cleanup Bot"
          git config --global user.email "cleanup@bookverse.demo"
          git add .github/cleanup-report.json
          git commit -m "chore: Clear cleanup report after successful execution

Cleanup completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
Project: bookverse
Status: Cleanup completed, new discovery required

This report has been cleared to prevent accidental re-execution.
Run 🔍 Discover Cleanup workflow to generate a new report."
          git push origin main
          echo "📋 Cleanup report cleared and committed"

      - name: 📋 Execute Cleanup Summary
        if: always()
        run: |
          echo "## 🗑️ Cleanup Execution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "✅ **Cleanup completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Cleanup failed or was cancelled**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "🔧 **Protection Skipped**: ${{ github.event.inputs.skip_protection }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 📋 Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. 👀 **Verify deletion on JFrog Platform**" >> $GITHUB_STEP_SUMMARY
          echo "2. 🚀 **Run Setup Platform workflow** to re-initialize the environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Important:" >> $GITHUB_STEP_SUMMARY
          echo "- This report summarizes the deletion attempt." >> $GITHUB_STEP_SUMMARY
          echo "- Always verify the actual state on your JFrog Platform." >> $GITHUB_STEP_SUMMARY
